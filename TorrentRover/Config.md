### Описание конфигурации (правил для сайтов)

В скрипте подкаста по Alt+3 должен быть валидный JSON, который может в себе содержать правила для распознавания ссылок на torrent-файлы и поиск возможных разделов на сайтах.

В нём находится массив объектов, имя которых - это имя сайта, для которого предназначены правила. Исключение составляет объект с именем "[Search](#Структура-объекта-Search)" - это специальный
объект, хранящий список правил для поиска на сайтах. Подробнее об этом объекте в [соответствующем разделе](#Структура-объекта-Search).

# Структура объекта правил обработки сайта
**Имя объекта - это имя домена**.  
Все значения для совпадения/условий - это регулярные выражения.

## Возможные имена объектов внутри правил для сайта:
* LoginCondition - условие для вызова процедуры входа на сайт;
* [Login](#Структура-Login) - блок, описывающий правила для входа на сайт;
* [Conditions](#Структура-Conditions) - список условий, при выполнении которых будут создаваться ссылки на торрент-файлы или разделы в подкасте;
* [Torrent](#Структура-Torrent) - блок, описывающий получение torrent-файла и информации о раздаче (количество сидов, длительность, дата, жанр, описание...);
* PHProxy - ссылка на PHP-скрипт, который загрузит по указанной ссылке и вернёт содержимое;
* Headers - объект, который в формате "Ключ":"Значение" может содержать дополнительные HTTP-заголовки, которые будут добавляться при запросах (например, `"Headers": {"X-Requested-With": "XMLHttpRequest"}`).

Обязательные поля только Conditions и Torrent.

### Структура Login
* Url - адрес для запроса (может содержать переменные `<LOGIN>`, `<PASSW>`, `<Любое-имя-переменной>`)
* Method - метод запроса ("GET", "POST" или любой другой. По-умолчанию "GET")
* PostData - строка данных для передачи при POST методе запроса
* NoRedirect - если 1, не следовать перенаправлениям при ответе от сервера
* NoCache - если 1, флаг указывающий не использовать уже установленный кэш и cookies для этого сайта
* Success - регулярное выражение; пойманное соответствие равно успешность входа на сайт. Ищется заголовках и теле ответа.
* VARS - объект, который может содержать пары "Ключ":"Значение", где ключ - имя переменной, значение - регулярка для поиска значения этой переменной. Может использоваться для подстановки в Url или PostData.

Обязательные поля только Url и Success. Остальные указывать необязательно.

### Структура Conditions
Массив, который содержит объекты, в которых могут быть следующие поля:
* ConditionLink - условие, которое проверяется в ссылке;
* ConditionText - условие, которое проверяется в загруженном тексте страницы;
* Rule - Название правила для создания ссылок на торрент файлы. Обычно это "[Torrent](#Структура-Torrent)";
* Block - если содержит, то в загруженном тексте страницы будут искаться блоки по указанной регулярке, в которых уже будут искаться Title и Link;
* Title - регулярка для поиска названия (также применяется HtmlToText - отбрасывание html-тегов);
* Link - регулярка для поиска ссылки;
* NextPage - поиск ссылки на следующую страницу. Если найдена - будет создана папка с соответствующим названием и найденной ссылкой.

Обязательные поля только ConditionLink **или** ConditionText. Если указан Block, то поля Title и Link тоже становятся обязательными.
Если не указан ни Rule, ни Block, то смысла в таком объекте нет.

Т.е. объект может описывать, что при условии совпадения регулярки в ссылке (или тексте загруженной страницы), может быть вызвано правило поиска информации на загруженной странице (ссылка на торрент-файл, дата и проч).
Или может описывать поиск блоков, по которым будут создаваться в подкасте соответствующие ссылки (на фильмы, разделы форума и проч).

Например, структура:  
```
"Conditions": [
      {
        "ConditionLink": "viewtopic.php\\?t=\\d+",
        "Rule": "Torrent"
      },
      {
        "ConditionText": "(forumlink|<a[^>]+id=\"tt-)",
        "Block"   : "(<h\\d[^>]+forumlink.*?</h\\d>|<a[^>]+id=\"tt-.*?</a>)",
        "Title"   : "(<a.*</a>)",
        "Link"    : "<a[^>]+href=\"(.*?)\"",
        "NextPage": ".*<a[^>]+class=\"pg\"[^>]+href=\"([^\"]+)\">След.</a>"
      }
    ],
```
Содержит два объекта.  
В первом сравнивается условие, что в текущая ссылка соответствует определённому шаблону, содержит "viewtopic.php?t=<цифры>".
Если это так, то будет запущен поиск информации на странице по правилу с именем "[Torrent](#Структура-Torrent)".  
Во втором указано условие "ConditionText" - т.е. поиск этого соответствия в загруженной странице.
Есть поле "Block" - а значит будет вестись поиск всех блоков текста 
по указанной регулярке. Для каждого найденного блока в подкасте будут создаваться папка, название которой берётся по регулярке Title, а ссылка по регулярке Link.  
Если по регулярке NextPage в загруженной странице будет найдена ссылка - то в конце будет создана папка с названием "След.страница" и ссылкой, которая будет равна найденному значению.

### Структура Torrent
* Url - регулярка для поиска ссылки на torrent-файл;
* Method - метод запроса для скачивания torrent-файла по найденной ссылке (по-умолчанию "GET");
* PostData - строка данных POST-запроса (могут быть использованы переменные в виде `<Любое-имя-переменной>`)
* VARS - объект, который может содержать пары "Ключ":"Значение", где ключ - имя переменной, значение - регулярка для поиска значения этой переменной. Может использоваться для подстановки переменных в Url или PostData.  
* Image - ссылка на картинку  

Регулярные выражения для создания информационных ссылок:
* Error - текст при ошибке получения torrent-файла
* Seeders - количество раздающих
* Leechers - количество качающих
* Date - дата добавления торрента
* Size - размер
* Quality - качество
* Year - год
* Duration - длительность
* Genre - жанр
* Author - автор / исполнитель
* Album - альбом
* Quality - качество
* Text - описание

Обязательное поле только Url. Остальные указывать необязательно.


Полный пример объекта для сайта rutracker37.tk с комментариями:
```
  "rutracker37.tk": {
    "LoginCondition": "login-form-quick",  // если в загруженной странице встречаем login-form-quick - то выполняем запрос в вход по правилу объекта "Login"
    "Login": {
      "Url"       : "https://rutracker37.tk/forum/login.php", // Запрос на вход будет по этому адресу
      "Method"    : "POST",
      "PostData"  : "login_username=<LOGIN>&login_password=<PASSW>&login=%C2%F5%EE%E4", // Данные POST запроса, где <LOGIN> и <PASSW> будут автоматически заменены на значения, указанные в свойствах папки подкаста для данного сайта.
      "NoRedirect": 1, // Не идти дальше по перенаправлениям, полученным в ответе от сервера
      "NoCache"   : 1, // Не использовать кэш и cookies
      "Success"   : "(302 Moved|302 Found|logout)" // Если в заголовках или теле ответа встретили "302 Moved" или "302 Found" или слово "logout", значит залогинились успешно.
    },
    "Conditions": [ // список условий и соответствующих к ним правил обработки
      {
        "ConditionLink": "viewtopic.php\\?t=\\d+", // Если в ссылке есть "viewtopic.php?t=<число>", это страница с описанием торрент файла.
        "Rule": "Torrent" // Имя правила, по которому будет идти обработка данных
      },
      {
        "ConditionText": "(forumlink|<a[^>]+id=\"tt-)", // Если в тексте загруженной страницы встречаем "forumlink" или ссылку "<a id="tt-..."
        "Block"   : "(<h\\d[^>]+forumlink.*?</h\\d>|<a[^>]+id=\"tt-.*?</a>)", // тогда ищем там блоки, в которых ищём имя и ссылку, если нашли будет создана папка в подкасте.
        "Title"   : "(<a.*</a>)",
        "Link"    : "<a[^>]+href=\"(.*?)\"",
        "NextPage": ".*<a[^>]+class=\"pg\"[^>]+href=\"([^\"]+)\">След.</a>" // Если есть ссылка на следующую страницу - создадим папку с соответствующим названием.
      }
    ],
    "Torrent": { // Если это страница выложенного торрент-файла, то создаём ссылку на торрент-файл и создаём информационные ссылке в текущей папке подкаста
      "Url"     : "(dl.php\\?t=\\d+)", // ссылка для скачивания торрент-файла
      "Method"  : "POST", // метод запроса
      "VARS"    : { "TOKEN": "form_token\\s*?:\\s*?[\"'](.*?)[\"']" }, // найдём значение для переменной <TOKEN>
      "PostData": "form_token=<TOKEN>", // при передаче POST данных, переменная <TOKEN> будет заменена на соответствующее значение
      "Error"   : "(<p[^>]+attach_link.*?</p>)", // если найти ссылку для скачивания torrent-файла не удалось, попытаемся найти текст объяснения по этой регулярке
      "Seeders" : "class=\"seed\">.*?(\\d+)", // информация - количество сидов
      "Leechers": "class=\"leech\">.*?(\\d+)", // информация - количество личей
      "Date"    : "Когда зарегистрирован.*?>(.*?)<", // информация - дата выкладывания torrent-файла
      "Size"    : "tor-size-humn.*?>(.*?)<", // информация - размер файлов
      "Image"   : "postImgAligned[^>]+title=\"(http[^\"]+(jpg|png))\"", информация - ссылка на постер/картинку
      "Year"    : "Год выпуска.*?(\\d{4})", // информация - год
      "Duration": "(?:Время звучания|Продолжительность)(.*?)<br", // информация - длительность (видео/всех аудио файлов и проч)
      "Genre"   : "Жанр.*?:(.*?)<", // информация - жанр
      "Subs"    : "Субтитры.*?:(.*?)<br", // информация - какие есть субтитры
      "Text"    : "(<div[^>]+post_body.*?)<div[^>]+sp-wrap" // информация - текст описания (используется при воспроизведении информационной ссылки)
    }
  }
```
# Структура объекта Search
Это массив объектов, описывающих, на каких сайтах будет происходить поиск названия из папки "Поиск".  
Возможные поля:
* Site - название домена (по этому названию ищется соответствующий [объект правил для сайта](#Структура-объекта-правил-обработки-сайта) из конфигурации);
* Enable - если 1 - включен, 0 - выключен поиск по нему;
* Url - ссылка для запроса поиска, должна в себя включать переменную `<TITLE>`, которая будет заменена на название искомого;
* Utf8 - если 1 - тогда название в переменную <TITLE> будет предварительно кодировано в UTF-8;
* Method - метод запроса ("GET или "POST");
* Block - регулярка для поиска блоков с информацией о фильме (в котором будут искаться Title и Link);
* Title - регулярка поиска названия (применяется HtmlToText - отбрасывание всех html-тегов);
* Link - регулярка поиска ссылки на фильм.
* PHProxy - ссылка на PHP-скрипт, который загрузит по указанной ссылке и вернёт содержимое;
* Headers - объект, который в формате "Ключ":"Значение" может содержать дополнительные HTTP-заголовки, которые будут добавляться при запросах (например, `"Headers": {"X-Requested-With": "XMLHttpRequest"}`).

Обязательные поля: Site, Url, Block, Title, Link.

Если в соответствующем Site и [объекте правил для сайта](#Структура-объекта-правил-обработки-сайта) есть поле "Login" и "LoginCondition", тогда будет выполнен запрос на вход по тем правилам, а потом уже только запрос на поиск.
